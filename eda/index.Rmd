---
title: "Analysis of Vaccinations in Washington State"
author: "Azim Abdul Wahid, Hannah Chung, Michelle To, Jamie Costales"
date: "`r Sys.Date()`"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("../scripts/enrollment.R")
source("../scripts/exemptions.R")
source("../scripts/districts_by_county.R")

library(ggplot2)
library(shiny)
library(knitr)
library(plotly)
library("maps")
library("mapproj")
```

## {.tabset}

### Introduction

```{r intro, echo =FALSE }

```
**History of Vaccines**

The story of vaccines did not begin with the first vaccine–Edward Jenner’s use of material from cowpox pustules to provide protection against smallpox. Rather, it begins with the long history of infectious disease in humans, and in particular, with early uses of smallpox material to provide immunity to that disease.

Evidence exists that the Chinese employed smallpox inoculation (or variolation, as such use of smallpox material was called) as early as 1000 CE. It was practiced in Africa and Turkey as well, before it spread to Europe and the Americas.

Edward Jenner’s innovations, begun with his successful 1796 use of cowpox material to create immunity to smallpox, quickly made the practice widespread. His method underwent medical and technological changes over the next 200 years, and eventually resulted in the eradication of smallpox.

Louis Pasteur’s 1885 rabies vaccine was the next to make an impact on human disease. And then, at the dawn of bacteriology, developments rapidly followed. Antitoxins and vaccines against diphtheria, tetanus, anthrax, cholera, plague, typhoid, tuberculosis, and more were developed through the 1930s.

The middle of the 20th century was an active time for vaccine research and development. Methods for growing viruses in the laboratory led to rapid discoveries and innovations, including the creation of vaccines for polio. Researchers targeted other common childhood diseases such as measles, mumps, and rubella, and vaccines for these diseases reduced the disease burden greatly.

**Domain of Interest**

The domain we originally started with was vaccinations. This domain piqued our interest as it’s a public health area that’s currently been getting more coverage especially as groups of anti-vaxxers are on the rise and there is a strong push to get a vaccine for COVID-19. Vaccines are also a public health intervention that can prevent or provide protection against many infections and diseases.

The domain we narrowed our assignment to was vaccinations within K-12 schools in Washington State. The dataset we’re using to gain more insight on this issue within the state is the [WA State K-12 Immunization Data 2016-2017](https://catalog.data.gov/dataset/all-students-kindergarten-through-12th-grade-immunization-data-by-school-2016-2017). It includes all the schools within the state and information on items such as the school population, location, percentage of vaccination exemptions (and what kind), percentage of how many students have all vaccinations, and much more. The data was downloaded from Data.gov which is managed and hosted by the U.S. General Services Administration, Technology Transformation Service. The data’s metadata was last updated January 16, 2020. For our analysis, we have filtered out the schools who did not report their vaccination data.

### Enrollment and Vaccines



**Comparing the Average School Size by County to Their Immunization %**


```{r enrollment_static, echo=FALSE}
enrollment_perc_complete_plotly

enrollment <- mean_enrollment
vacinated <- mean_perc_vacinated

```

 
A question we wanted to answer was “do larger schools have higher percentages of all vaccinations completed?” We thought that larger schools may push or require its families to vaccinate their children as disease could spread faster and impact more people due to a larger population that is typically in close contact. Before creating this plot, we found that the mean enrollment size in each school in the state  is `r mean_enrollment` students and that the mean percentage complete for all vaccinations in the whole state is `r mean_perc_vacinated`. 

This plot compares the counties within the state and provides their average enrollments and average percent of having completed all vaccinations. The trendline shows that there is a slight positive correlation which can indicate that larger schools have more children who have received all vaccinations.


**Comparing Schools Within a Specific County And Immunization %**

```{r enrollment_plotly, echo=FALSE}
selectInput(
  "county_choice", 
  label = h3("Choose County"), 
  choices = county_counts$County, 
  selected = 1)


renderPlotly ({
    county_filtered <- vac_2017 %>%
      filter(Percent_complete_for_all_immunizations != "NA") %>%
      filter(County == input$county_choice) 
    
     fit_two <- lm(Percent_complete_for_all_immunizations ~ K_12_enrollment, data = county_filtered)
    
    scatterplot <- plot_ly(data = county_filtered,
                             type = "scatter",
                             x = ~K_12_enrollment,
                             y = ~Percent_complete_for_all_immunizations,
                             mode = "markers",
                             colors = "#246A73",
                             marker = list(size = 5),
                             #size = 1,
                             text = ~paste(School_Name)) %>%
        add_lines(x = ~K_12_enrollment, y = fitted(fit_two), width = 1) %>% 
        layout(title = paste("School Enrollment Size and % Immunized in", input$county_choice, "county"),
               xaxis = list(title = "Student Enrollment Size"),
               yaxis = list(title = "Percent Complete for all Immunizations"),
               showlegend = FALSE)
      
    return(scatterplot)
     
  })


```

### Reasons for No Vaccination

**Inquiries**

We wanted to know more about the distribution of the reasons for not vaccinating. We thought that if we knew the distribution, we would know where to best focus efforts in addressing the lack of vaccination.

This pie chart displays the count and percentage of the different reasons for not vaccinating. We can deduce that not vaccinating due to personal exemption makes up 71.6% (44,104 children) of the total number of children (61,598 children) who didn’t get vaccinated. We see that we should be focusing our efforts in targeting children who have personal exemptions.

```{r exemptions, echo=FALSE}
checkboxGroupInput(
        "exemptions",
        label = h3("Exemption Reasons"),
        choices = list(
          "Personal" = exemption_sums$`Personal exemption`,
          "Medical" = exemption_sums$`Medical exemption`,
          "Religious" = exemption_sums$`Religious exemption`,
          "Religious membership" = exemption_sums$`Religious membership exemption`
        ),
        selected = c(exemption_sums$`Personal exemption`, exemption_sums$`Medical exemption`,
                     exemption_sums$`Religious exemption`, exemption_sums$`Religious membership exemption`)
)
renderPlotly({
  # make df based on input
   exemption_modified <- exemption_summary %>%
     filter(count %in% input$exemptions)
     # filter(count == input$exemptions)
  
  # plotly piechart to display counts and percentages
  exemption_plot <- plot_ly(data = exemption_modified, labels = ~reasons,
                           values = ~count, type = 'pie')
  
  exemption_plot <- exemption_plot %>%
    layout(title = 'Exemption Count and Percentages',
           xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
})
```

**Research and Future Implications**

Another cause for concern is the number of disease outbreaks attributed to religious groups. For example, since recorded in September 2018, there are 535 confirmed cases of measles among Orthodox Jewish communities in Brooklyn and Queens alone, a disease previously declared eradicated in the U.S. in year 2000.
  
Recent trends have shown that in states where there is a ban on personal exemptions, there have been a rise in religious exemptions despite only a few religions that are against vaccinations. An example is the state of Vermont. The state banned personal exemptions and in the following years, there were 7x more religious exemptions than before the ban.
  
In May 2019, the Washington State Legislature passed a bill that removes the personal and philosophical option to exempt children from the MMR (measles, mumps, and rubella) vaccine required for school and child care entry. This law does not change religious and medical exemption laws. The data used to produce the charts is data from the 2017 school year, before the bill was passed. Although there will be a decline in the number of personal exemptions, there might be an increase in religious exemptions.

### Immunization by County
```{r, echo=FALSE}
county_plot
```

To get a better grasp on the variation of immunization rates throughout the state we decided to map out the rates at which counties had immunizations based on data collected from those attending K-12 education. The percentage of immunizations were calculated by dividing the number of complete immunizations in students by the total number of students enrolled. 

This figure shows us the variation of rates amongst different counties in the state which may allow us to draw out some interesting insights. An important takeway that we wanted to highlight from the results of this figure is to be cognisant of population densities within these individual counties and how they may affect the overall percentage and rate at which immunizations are taken. 

### Immunization by District

Based on the data we have for WA state, we are also curious to see if there is a relationship between county and district in terms of immunization rates and population density. For example, King County consists of many school districts (i.e. Seattle, Issaquah, Federal Way, etc.), so if we were to take a look at the immunization rate for King County, the rates for the school districts, and the population density for each county, is there a trend? With this question, we also need to remember that the population not only consists of K-12 students, but infants, college students, adults, and the elderly as well. (Note: I have not reflected the population density into the visualizations yet.)

The following visualizations show the ratio of students who have recieved all immunizations to those who have not based on district. The percentage was calculated by taking the total number of students who have recieved all immunizations divided by the total number of students enrolled in each district. A similar plot based on the counties has been provided for reference. 

```{r districts_by_county, echo=FALSE, warning=FALSE}
districts_top10_plot
selectInput("County", label = "Select County", choices = names(districts_in_counties))
renderPlotly(dis_plot_func(get(input$County), input$County))
renderTable(get(input$County))
```

### Conclusions

A ban on personal exemptions may not be the best option to go about increasing vaccination completion among kids in school. Religious exemptions may be an increasingly problematic or outdated exemption category, and researchers and policy makers must work together to determine how best to balance a respect for religious liberty with the need to protect public health.
