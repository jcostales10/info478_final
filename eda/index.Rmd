---
title: "Analysis of K-12 Immunization in WA State (2016-17)"
author: "Azim Abdul Wahid, Hannah Chung, Michelle To, Jamie Costales"
date: "6/8/2020"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("../scripts/enrollment.R")
source("../scripts/exemptions.R")
source("../scripts/districts_by_county.R")

#install.packages("DT")

library(ggplot2)
library(shiny)
library(knitr)
library(plotly)
library(DT)
library("maps")
library("mapproj")
```

## {.tabset}

### Introduction
**History of Vaccines**

The story of vaccines did not begin with the first vaccine–Edward Jenner’s use of material from cowpox pustules to provide protection against smallpox. Rather, it begins with the long history of infectious disease in humans, and in particular, with early uses of smallpox material to provide immunity to that disease.

Evidence exists that the Chinese employed smallpox inoculation (or variolation, as such use of smallpox material was called) as early as 1000 CE. It was practiced in Africa and Turkey as well, before it spread to Europe and the Americas.

Edward Jenner’s innovations, begun with his successful 1796 use of cowpox material to create immunity to smallpox, quickly made the practice widespread. His method underwent medical and technological changes over the next 200 years, and eventually resulted in the eradication of smallpox.

Louis Pasteur’s 1885 rabies vaccine was the next to make an impact on human disease. And then, at the dawn of bacteriology, developments rapidly followed. Antitoxins and vaccines against diphtheria, tetanus, anthrax, cholera, plague, typhoid, tuberculosis, and more were developed through the 1930s.

The middle of the 20th century was an active time for vaccine research and development. Methods for growing viruses in the laboratory led to rapid discoveries and innovations, including the creation of vaccines for polio. Researchers targeted other common childhood diseases such as measles, mumps, and rubella, and vaccines for these diseases reduced the disease burden greatly.

**Domain of Interest**

The domain this project focuses on is vaccinations within Washington State; more specifically Immunizations in the K-12 schools. This domain piqued our interest as it’s a public health area that’s currently been getting more coverage especially as groups of anti-vaxxers are on the rise and there is a strong push to get a vaccine for COVID-19. We also decided to focus on Washington State as it’s where we all currently reside, so we thought it would be interesting to learn more about a topic that’s very important, in a place that impacts us.

**Purpose**

The purpose of this project is to better educate and to bring potential issues to light for law/policy makers, parents, and the general public in regards to the topic of vaccinations within the K-12 system. As students invested in the well being of individuals and populations, we decided that investigating the topic of vaccinations is important as there are many infectious or serious infections and [diseases that can be prevented by vaccinations](https://www.cdc.gov/vaccines/vpd/vaccines-diseases.html) such as chickenpox, the Flu, HPV, Meningococcal Meningitis, and Whooping Cough. 

**The Dataset** 

The dataset we’re using to gain more insight on this issue within the state is the [WA State K-12 Immunization Data 2016-2017](https://catalog.data.gov/dataset/all-students-kindergarten-through-12th-grade-immunization-data-by-school-2016-2017). It includes all the schools within the state and information on items such as the school population, location, percentage of vaccination exemptions (and what kind), percentage of how many students have all vaccinations, and much more. The data was downloaded from Data.gov which is managed and hosted by the U.S. General Services Administration, Technology Transformation Service. The data’s metadata was last updated January 16, 2020. For our analysis, we have filtered out the schools who did not report their vaccination data.

### Enrollment

```{r enrollment_stats, echo=FALSE}
enrollment <- mean_enrollment
vacinated <- mean_perc_vacinated
```

**Inquiries**

One of the overarching questions we wanted to explore further was “do higher percentages of all vaccinations completed have some relationship to a school’s enrollment size?” We thought that this would be a good question to investigate since larger school populations meant that a larger group of people could be exposed and impacted if an infection were to happen. Before creating any of the plots, we found that the mean enrollment size in each school in the state  is `r mean_enrollment` and that the mean percentage complete for all vaccinations in the whole state is `r mean_perc_vacinated`. 

Another question that stems off the previous was “what are the possible trends like for the schools in each county?”. As one of our main target audience members were lawmakers, we wanted to give them the ability to focus in on their county specifically and learn which schools may have lower/higher percent completion for all vaccinations. This could also be beneficial for our other target audience of parents as they can see how their school may contribute to the trendline for the county.

***

**Addressing the First Question: Viewing WA as a whole**

***

```{r enrollment_static, echo=FALSE}
enrollment_perc_complete_plotly
```

The ‘WA K-12 Enrollment Sizes and % Vaccinated with All Vaccines by County’ plot compares the counties within the state and provides their average enrollments and average percent of having completed all vaccinations. The trendline shows that there is a slight positive correlation which can indicate that larger schools tend to have a higher percentage of children in their school who have received all vaccinations. It can indicate that as a state, we are headed towards a positive direction, but there are still outliers that remind us that we can still do better, which can be a call to action to lawmakers.

***
 
**Addressing the Second Question: Comparing Trends of Specific Counties**

***

When viewed individually, there is a lot of variation between each county in terms of vaccination trend, number of schools per county, and where their distributions typically fall. According to [outside research](https://worldpopulationreview.com/states/washington-population/) and some data wrangling in R, the most densely populated counties and counties with the most enrolled students within Washington are `r top_three_enrollment` with the respective values of `r top_three_enrollment_values` students. The trends for these population dense counties, which also encapsulate many individual schools, are only slightly positive with lines that are almost flat but have a slight tilt upward to the right. This could signal that there may also not be a correlation between enrollment size and percent complete immunized/school. The counties with the smallest enrollment sizes are `r bottom_three_enrollment` with the respective values of `r bottom_three_enrollment_values` students which all show either strongly positive trends or no trend at all due to lack of supplemental points.

The counties with the lowest percent complete all vaccinations are `r bottom_three_vac_perc` with the respective values of `r bottom_three_vac_perc_values` percents which were interesting explore as Stevens and Jefferson both had strongly positive trends although their averages, when compared to everyone else', were fairly lower. San Juan on the other hand had a trendline that was mostly flat, but had a slight negative tilt. It was interesting to see the plots of separate counties as Stevens and Jefferson support the potential relationship between school size and percent all vaccinated, however their low values as an average signal that there is can still be a lot done to better vaccination rates within each county specifically. 

```{r enrollment_plotly, echo=FALSE}
selectInput(
  "county_choice", 
  label = h3("Choose County"), 
  choices = county_counts$County, 
  selected = 1)


renderPlotly ({
    county_filtered <- vac_2017 %>%
      filter(Percent_complete_for_all_immunizations != "NA") %>%
      filter(County == input$county_choice) 
    
     fit_two <- lm(Percent_complete_for_all_immunizations ~ K_12_enrollment, data = county_filtered)
    
    scatterplot <- plot_ly(data = county_filtered,
                             type = "scatter",
                             x = ~K_12_enrollment,
                             y = ~Percent_complete_for_all_immunizations,
                             #mode = "markers",
                             colors = "#246A73",
                             #marker = list(size = 5),
                             #size = 1,
                             text = ~paste(School_Name)) %>%
        add_lines(x = ~K_12_enrollment, y = fitted(fit_two)) %>% 
        layout(title = paste("School Enrollment Size and % Immunized in", input$county_choice, "county"),
               xaxis = list(title = "Student Enrollment Size"),
               yaxis = list(title = "Percent Complete for all Immunizations"),
               showlegend = FALSE)
      
    return(scatterplot)
     
  })


```

### Exemptions

**Inquiries**

We wanted to know more about the distribution of the reasons for not vaccinating. We thought that if we knew the distribution, we would know where to best focus efforts in addressing the lack of vaccination.

This pie chart displays the count and percentage of the different reasons for not vaccinating. We can deduce that not vaccinating due to personal exemption makes up 71.6% (44,104 children) of the total number of children (61,598 children) who didn’t get vaccinated. We see that we should be focusing our efforts in targeting children who have personal exemptions.

```{r exemptions, echo=FALSE}
checkboxGroupInput(
        "exemptions",
        label = h3("Exemption Reasons"),
        choices = list(
          "Personal" = exemption_sums$`Personal exemption`,
          "Medical" = exemption_sums$`Medical exemption`,
          "Religious" = exemption_sums$`Religious exemption`,
          "Religious membership" = exemption_sums$`Religious membership exemption`
        ),
        selected = c(exemption_sums$`Personal exemption`, exemption_sums$`Medical exemption`,
                     exemption_sums$`Religious exemption`, exemption_sums$`Religious membership exemption`)
)
renderPlotly({
  # make df based on input
   exemption_modified <- exemption_summary %>%
     filter(count %in% input$exemptions)
     # filter(count == input$exemptions)
  
  # plotly piechart to display counts and percentages
  exemption_plot <- plot_ly(data = exemption_modified, labels = ~reasons,
                           values = ~count, type = 'pie')
  
  exemption_plot <- exemption_plot %>%
    layout(title = 'Exemption Count and Percentages',
           xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
})
```

***

**Research and Future Implications**

***

Another cause for concern is the number of disease outbreaks attributed to religious groups. For example, since recorded in September 2018, there are 535 confirmed cases of measles among Orthodox Jewish communities in Brooklyn and Queens alone, a disease previously declared eradicated in the U.S. in year 2000.
  
Recent trends have shown that in states where there is a ban on personal exemptions, there have been a rise in religious exemptions despite only a few religions that are against vaccinations. An example is the state of Vermont. The state banned personal exemptions and in the following years, there were 7x more religious exemptions than before the ban.
  
In May 2019, the Washington State Legislature passed a bill that removes the personal and philosophical option to exempt children from the MMR (measles, mumps, and rubella) vaccine required for school and child care entry. This law does not change religious and medical exemption laws. The data used to produce the charts is data from the 2017 school year, before the bill was passed. Although there will be a decline in the number of personal exemptions, there might be an increase in religious exemptions.

### By County
```{r, echo=FALSE}
county_plot
```

To get a better grasp on the variation of immunization rates throughout the state we decided to map out the rates at which counties had immunizations based on data collected from those attending K-12 education. The percentage of immunizations were calculated by dividing the number of complete immunizations in students by the total number of students enrolled. 

This figure shows us the variation of rates amongst different counties in the state which may allow us to draw out some interesting insights. An important takeway that we wanted to highlight from the results of this figure is to be cognisant of population densities within these individual counties and how they may affect the overall percentage and rate at which immunizations are taken. 

### By District
From the Highest/Lowest Immunization Rates tab, we can see the ten school districts with the highest immunization rates and the ten school districts with the lowest immunization rates. 
The Districts by Counties tab provides a visual comparison for all the school districts in the selected county. The WA state immunization rate, based on districts, is about 84%.

Some factors that may play a role in low immunization rates are poor health care coverage or low income. Based on our data analysis and the following resources, we are able to determine whether or not these factors do impact immunization rates:

- [2017 Health Care Coverage](https://www.ofm.wa.gov/sites/default/files/public/dataresearch/researchbriefs/brief092.pdf)
- [2016 - 2017 Free or Reduced Lunch](https://public.tableau.com/profile/havala.hanson#!/vizhome/Percentageofstudentseligibleforfreeorreduced-pricelunch/FRPL)
- [2015 Student Poverty](http://viz.edbuild.org/maps/2015/dividing-lines/)

```{r districts_by_county, echo=FALSE, warning=FALSE}
tabsetPanel(
  tabPanel("Highest/Lowest Immunization Rates",
           p(""),
           radioButtons("Ten", label = "Immunization Rates by School District",
             choices = c("Highest", "Lowest"), selected = "Highest"),
           p("The ten school districts with the highest immunization rates range from 97.91% to
             100%, while the ten school districts with the lowest immunization rates range from 0%
             to 55.55%."),
           renderPlotly(get(input$Ten)),
           p("After looking at the highest and lowest visualizations, we were curious to see if
             the corresponding counties had similar immunization rates.")),
  tabPanel("Districts by Counties",
           p(""),
           selectInput("County", label = "Select County", choices = names(districts_in_counties)),
           p(renderText(paste("The average immunization rate for ", input$County, " county is: ",
                            signif(mean(get(input$County)$Immunization_Percentage), 4), "%",
                            sep = ""))),
           renderPlotly(dis_plot_func(get(input$County), input$County)),
           p("Few counties have relatively consistent rates among the districts (i.e. Whatcom
             County) while majority of the counties have varying rates among the districts. Below
             is a table based on the selected county that reflects the data and the number of
             students who were exempt from immunizations."),
           DT::renderDataTable(get(input$County), options = list(scrollX = TRUE),
                               rownames = FALSE, colnames = c("School District",
                                                              "K-12 Enrollment",
                                                              "# Complete Immunization",
                                                              "# Any Exemption",
                                                              "# Medical Exemption",
                                                              "# Personal Exemption",
                                                              "# Religious Exemption",
                                                              "# Religious Membership Exemption",
                                                              "# Exempt: Diphtheria Tetanus",
                                                              "# Exempt: Pertussis",
                                                              "# Exempt: Measles, Mumps, Rubella",
                                                              "# Exempt: Polio",
                                                              "# Exempt: HepatitisB",
                                                              "# Exempt: Varicella",
                                                              "Immunization %", "County"))),
  tabPanel("Analysis",
           p("Based on the 2016-17 K-12 data used, we are able to see that some students are
             exempt due to medical, personal, or religious reasons. A future application could
             compare the exemption rates between the counties/districts to find the primary
             factors for each county/districts."),
           p("From the 2017 Health Care Coverage data, it appears that 94.5% of the WA population
             does have access to health insurance, which seems to match up with 84% of the K-12
             respondents who have gotten all the immunizations."),
           p("However, the reasoning that lower income areas having lower immunization rates seems
             to be a bit hazy based on comparisons of our data analysis, the 2016 - 2017 Free or
             Reduced Lunch map, and 2015 Student Poverty map."),
           p("For example, Othello School District has an immunization rate of 93.52%, a free or
             reduced lunch rate of 82%, and student poverty rate of 23.7%. Methow Valley School
             District has an immunization rate of 68.87%, free or reduced lunch rate of 40%, and
             student poverty rate of 26.2%. While the Issaquah School district has an immunization
             rate of 95.36%, free or reduced lunch rate of 8%, and student poverty rate of
             4.7%."),
           p("From varying comparisons, it seems that there is a slight correlation between low
             income areas and low immunization rates, but there are also several outliers that
             counter this trend.")))
```

### Conclusions

***

**In Terms of Enrollment**

***
Although positive trend upwards were nice to see in regards to school enrollment sizes and percent complete - all vaccinations which meant that students with higher populations typically also had higher percentages of students who had completed all their vaccinations, it is also important to remember in this case that the goal is to see a flatter trendline positioned at around 95% or higher throughout Washington and for each county as this would indicate that each school, regardless of their enrollment size, has herd immunity throughout as most of the student body is completely immunized. Since this is not the case for many counties in Washington, and Washington as a whole, there is still a lot of work and advocacy to be done by parents, the general public, and lawmakers to ensure that the amount of students who receive all their vaccinations are accomplished. This is especially more pressing in these times of COVID-19 as when a vaccine is achieved in the future, it's important that there are policies in place that allow for herd immunity to be reached as we've seen how easily COVID-19 can be spread along with how fatal it can be. With that, there also comes the issues that are tied to vaccination/the ability to get vaccinated such as the costs of vaccines and their accessibility. There is still a lot to be done, and we hope that through the visualizations and analysis presented, policy/lawmakers, parents, and the general public now have a better understanding of vaccinations within a frame of enrollment size.

***

**In Terms of Excemptions**

***
A ban on personal exemptions may not be the best option to go about increasing vaccination completion among kids in school. Religious exemptions may be an increasingly problematic or outdated exemption category, and researchers and policy makers must work together to determine how best to balance a respect for religious liberty with the need to protect public health.

***

**By Districts**

***
While vaccination education is important, it is also important that everyone has means of obtaining them. There are varying reasons why some students are not fully immunized, but the factor of low income or lack of health care coverage should not be one of them. In order to raise the immunization rate in Washington state, health care policies should be modified and applied to ensure that everyone has safe access. Being able to recieve the necessary vaccines not only prevents one from getting ill, but also ensures that one will not incur [medical fees](https://www.cdc.gov/vaccines/programs/vfc/pubs/methods/index.html).