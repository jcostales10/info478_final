---
title: "Analysis of Vaccinations in Washington State"
author: "Azim Abdul Wahid, Hannah Chung, Michelle To, Jamie Costales"
date: "`r Sys.Date()`"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("../scripts/enrollment.R")
source("../scripts/exemptions.R")
source("../scripts/districts_by_county.R")

library(ggplot2)
library(shiny)
library(knitr)
library(plotly)
library("maps")
library("mapproj")
```

## {.tabset}

### Introduction

```{r intro, echo =FALSE }

```
**History of Vaccines**

The story of vaccines did not begin with the first vaccine–Edward Jenner’s use of material from cowpox pustules to provide protection against smallpox. Rather, it begins with the long history of infectious disease in humans, and in particular, with early uses of smallpox material to provide immunity to that disease.

Evidence exists that the Chinese employed smallpox inoculation (or variolation, as such use of smallpox material was called) as early as 1000 CE. It was practiced in Africa and Turkey as well, before it spread to Europe and the Americas.

Edward Jenner’s innovations, begun with his successful 1796 use of cowpox material to create immunity to smallpox, quickly made the practice widespread. His method underwent medical and technological changes over the next 200 years, and eventually resulted in the eradication of smallpox.

Louis Pasteur’s 1885 rabies vaccine was the next to make an impact on human disease. And then, at the dawn of bacteriology, developments rapidly followed. Antitoxins and vaccines against diphtheria, tetanus, anthrax, cholera, plague, typhoid, tuberculosis, and more were developed through the 1930s.

The middle of the 20th century was an active time for vaccine research and development. Methods for growing viruses in the laboratory led to rapid discoveries and innovations, including the creation of vaccines for polio. Researchers targeted other common childhood diseases such as measles, mumps, and rubella, and vaccines for these diseases reduced the disease burden greatly.

**Domain of Interest**

The domain we originally started with was vaccinations. This domain piqued our interest as it’s a public health area that’s currently been getting more coverage especially as groups of anti-vaxxers are on the rise and there is a strong push to get a vaccine for COVID-19. Vaccines are also a public health intervention that can prevent or provide protection against many infections and diseases.

The domain we narrowed our assignment to was vaccinations within K-12 schools in Washington State. The dataset we’re using to gain more insight on this issue within the state is the [WA State K-12 Immunization Data 2016-2017](https://catalog.data.gov/dataset/all-students-kindergarten-through-12th-grade-immunization-data-by-school-2016-2017). It includes all the schools within the state and information on items such as the school population, location, percentage of vaccination exemptions (and what kind), percentage of how many students have all vaccinations, and much more. The data was downloaded from Data.gov which is managed and hosted by the U.S. General Services Administration, Technology Transformation Service. The data’s metadata was last updated January 16, 2020. For our analysis, we have filtered out the schools who did not report their vaccination data.

### Enrollment and Vaccines

```{r enrollment_stats, echo=FALSE}
enrollment <- mean_enrollment
vacinated <- mean_perc_vacinated

```

**Inquiries**


One of the overarching questions we wanted to explore further was “do higher percentages of all vaccinations completed have some relationship to a school’s enrollment size?” We thought that this would be a good question to investigate since larger school populations meant that a larger group of people could be exposed and impacted if an infection were to happen. Before creating any of the plots, we found that the mean enrollment size in each school in the state  is `r mean_enrollment` and that the mean percentage complete for all vaccinations in the whole state is `r mean_perc_vacinated`. 

Another question that stems off the previous was “what are the possible trends like for the schools in each county?”. As one of our main target audience members were lawmakers, we wanted to give them the ability to focus in on their county specifically and learn which schools may have lower/higher percent completion for all vaccinations. This could also be beneficial for our other target audience of parents as they can see how their school may contribute to the trendline for the county.

***

**Addressing the First Question: Viewing WA as a whole**

***

```{r enrollment_static, echo=FALSE}
enrollment_perc_complete_plotly

```

The ‘WA K-12 Enrollment Sizes and % Vaccinated with All Vaccines by County’ plot compares the counties within the state and provides their average enrollments and average percent of having completed all vaccinations. The trendline shows that there is a slight positive correlation which can indicate that larger schools tend to have a higher percentage of children in their school who have received all vaccinations. It can indicate that as a state, we are headed towards a positive direction, but there are still outliers that remind us that we can still do better, which can be a call to action to lawmakers.

***
 
**Addressing the Second Question: Comparing Trends of Specific Counties**

***

When viewed individually, there is a lot of variation between each county in terms of vaccination trend, number of schools per county, and where their distributions typically fall. According to [outside research](https://worldpopulationreview.com/states/washington-population/) and some data wrangling in R, the most densely populated counties and counties with the most enrolled students within Washington are `r top_three_enrollment` with the respective values of `r top_three_enrollment_values` students. The trends for these population dense counties, which also encapsulate many individual schools, are only slightly positive with lines that are almost flat but have a slight tilt upward to the right. This could signal that there may also not be a correlation between enrollment size and percent complete immunized/school. The counties with the smallest enrollment sizes are `r bottom_three_enrollment` with the respective values of `r bottom_three_enrollment_values` students which all show either strongly positive trends or no trend at all due to lack of supplemental points.

The counties with the lowest percent complete all vaccinations are `r bottom_three_vac_perc` with the respective values of `r bottom_three_vac_perc_values` percents which were interesting explore as Stevens and Jefferson both had strongly positive trends although their averages, when compared to everyone else', were fairly lower. San Juan on the other hand had a trendline that was mostly flat, but had a slight negative tilt. It was interesting to see the plots of separate counties as Stevens and Jefferson support the potential relationship between school size and percent all vaccinated, however their low values as an average signal that there is can still be a lot done to better vaccination rates within each county specifically. 


```{r enrollment_plotly, echo=FALSE}
selectInput(
  "county_choice", 
  label = h3("Choose County"), 
  choices = county_counts$County, 
  selected = 1)


renderPlotly ({
    county_filtered <- vac_2017 %>%
      filter(Percent_complete_for_all_immunizations != "NA") %>%
      filter(County == input$county_choice) 
    
     fit_two <- lm(Percent_complete_for_all_immunizations ~ K_12_enrollment, data = county_filtered)
    
    scatterplot <- plot_ly(data = county_filtered,
                             type = "scatter",
                             x = ~K_12_enrollment,
                             y = ~Percent_complete_for_all_immunizations,
                             #mode = "markers",
                             colors = "#246A73",
                             #marker = list(size = 5),
                             #size = 1,
                             text = ~paste(School_Name)) %>%
        add_lines(x = ~K_12_enrollment, y = fitted(fit_two)) %>% 
        layout(title = paste("School Enrollment Size and % Immunized in", input$county_choice, "county"),
               xaxis = list(title = "Student Enrollment Size"),
               yaxis = list(title = "Percent Complete for all Immunizations"),
               showlegend = FALSE)
      
    return(scatterplot)
     
  })


```

### Reasons for No Vaccination

**Inquiries**

We wanted to know more about the distribution of the reasons for not vaccinating. We thought that if we knew the distribution, we would know where to best focus efforts in addressing the lack of vaccination.

This pie chart displays the count and percentage of the different reasons for not vaccinating. We can deduce that not vaccinating due to personal exemption makes up 71.6% (44,104 children) of the total number of children (61,598 children) who didn’t get vaccinated. We see that we should be focusing our efforts in targeting children who have personal exemptions.

```{r exemptions, echo=FALSE}
checkboxGroupInput(
        "exemptions",
        label = h3("Exemption Reasons"),
        choices = list(
          "Personal" = exemption_sums$`Personal exemption`,
          "Medical" = exemption_sums$`Medical exemption`,
          "Religious" = exemption_sums$`Religious exemption`,
          "Religious membership" = exemption_sums$`Religious membership exemption`
        ),
        selected = c(exemption_sums$`Personal exemption`, exemption_sums$`Medical exemption`,
                     exemption_sums$`Religious exemption`, exemption_sums$`Religious membership exemption`)
)
renderPlotly({
  # make df based on input
   exemption_modified <- exemption_summary %>%
     filter(count %in% input$exemptions)
     # filter(count == input$exemptions)
  
  # plotly piechart to display counts and percentages
  exemption_plot <- plot_ly(data = exemption_modified, labels = ~reasons,
                           values = ~count, type = 'pie')
  
  exemption_plot <- exemption_plot %>%
    layout(title = 'Exemption Count and Percentages',
           xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
})
```

**Research and Future Implications**

Another cause for concern is the number of disease outbreaks attributed to religious groups. For example, since recorded in September 2018, there are 535 confirmed cases of measles among Orthodox Jewish communities in Brooklyn and Queens alone, a disease previously declared eradicated in the U.S. in year 2000.
  
Recent trends have shown that in states where there is a ban on personal exemptions, there have been a rise in religious exemptions despite only a few religions that are against vaccinations. An example is the state of Vermont. The state banned personal exemptions and in the following years, there were 7x more religious exemptions than before the ban.
  
In May 2019, the Washington State Legislature passed a bill that removes the personal and philosophical option to exempt children from the MMR (measles, mumps, and rubella) vaccine required for school and child care entry. This law does not change religious and medical exemption laws. The data used to produce the charts is data from the 2017 school year, before the bill was passed. Although there will be a decline in the number of personal exemptions, there might be an increase in religious exemptions.

### Immunization by County
```{r, echo=FALSE}
county_plot
```

To get a better grasp on the variation of immunization rates throughout the state we decided to map out the rates at which counties had immunizations based on data collected from those attending K-12 education. The percentage of immunizations were calculated by dividing the number of complete immunizations in students by the total number of students enrolled. 

This figure shows us the variation of rates amongst different counties in the state which may allow us to draw out some interesting insights. An important takeway that we wanted to highlight from the results of this figure is to be cognisant of population densities within these individual counties and how they may affect the overall percentage and rate at which immunizations are taken. 

### Immunization by District

Based on the data we have for WA state, we are also curious to see if there is a relationship between county and district in terms of immunization rates and population density. For example, King County consists of many school districts (i.e. Seattle, Issaquah, Federal Way, etc.), so if we were to take a look at the immunization rate for King County, the rates for the school districts, and the population density for each county, is there a trend? With this question, we also need to remember that the population not only consists of K-12 students, but infants, college students, adults, and the elderly as well. (Note: I have not reflected the population density into the visualizations yet.)

The following visualizations show the ratio of students who have recieved all immunizations to those who have not based on district. The percentage was calculated by taking the total number of students who have recieved all immunizations divided by the total number of students enrolled in each district. A similar plot based on the counties has been provided for reference. 

```{r districts_by_county, echo=FALSE, warning=FALSE}
districts_top10_plot
selectInput("County", label = "Select County", choices = names(districts_in_counties))
renderPlotly(dis_plot_func(get(input$County), input$County))
renderTable(get(input$County))
```

### Conclusions

***

**In Terms of Enrollment**

***
Although positive trend upwards were nice to see in regards to school enrollment sizes and percent complete - all vaccinations which meant that students with higher populations typically also had higher percentages of students who had completed all their vaccinations, it is also important to remember in this case that the goal is to see a flatter trendline positioned at around 95% or higher throughout Washington and for each county as this would indicate that each school, regardless of their enrollment size, has herd immunity throughout as most of the student body is completely immunized. Since this is not the case for many counties in Washington, and Washington as a whole, there is still a lot of work and advocacy to be done by parents, the general public, and lawmakers to ensure that the amount of students who receive all their vaccinations are accomplished. This is especially more pressing in these times of COVID-19 as when a vaccine is achieved in the future, it's important that there are policies in place that allow for herd immunity to be reached as we've seen how easily COVID-19 can be spread along with how fatal it can be. With that, there also comes the issues that are tied to vaccination/the ability to get vaccinated such as the costs of vaccines and their accessibility. There is still a lot to be done, and we hope that through the visualizations and analysis presented, policy/lawmakers, parents, and the general public now have a better understanding of vaccinations within a frame of enrollment size.

***

**In Terms of Excemptions**

***
A ban on personal exemptions may not be the best option to go about increasing vaccination completion among kids in school. Religious exemptions may be an increasingly problematic or outdated exemption category, and researchers and policy makers must work together to determine how best to balance a respect for religious liberty with the need to protect public health.
